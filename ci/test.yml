---
platform: linux

image_resource:
  type: registry-image
  source: { repository: debian, tag: buster }

inputs:
  - name: ns8-magento-platform

run:
  path: /bin/sh
  args:
    - -c
    - |
      apt-get update

      apt-get install -y \
        composer \
        curl \
        php \
        php-bcmath \
        php-curl \
        php-dom \
        php-gd \
        php-intl \
        php-mbstring \
        php-mysql \
        php-soap \
        php-xdebug \
        php-zip \
        unzip \
        yarnpkg

      echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN}' > ~/.npmrc
      cd ns8-magento-platform

      if ! yarnpkg
      then
        >&2 echo 'ERROR: Yarn install failed'
        exit 1
      fi

      if ! yarnpkg test
      then
        >&2 echo 'ERROR: Switches tests failed'
        exit 1
      fi

      if ! yarnpkg lint
      then
        >&2 echo 'ERROR: Switches lint failed'
        exit 1
      fi

      cd module

      if ! composer install --no-autoloader --no-progress
      then
        >&2 echo 'ERROR: Composer install failed'
        exit 1
      fi

      if ! vendor/bin/phpcs --config-set installed_paths vendor/magento/magento-coding-standard/Magento2
      then
        >&2 echo 'ERROR: PHP_CodeSniffer setup failed'
        exit 1
      fi

      if ! composer lint
      then
        >&2 echo 'ERROR: PHP lint check failed'
        exit 1
      fi

      if ! curl -o /tmp/magento.zip https://$MAGENTO_USER:$MAGENTO_PASS@www.magentocommerce.com/products/downloads/file/Magento-CE-2.3.4_sample_data.zip
      then
        >&2 echo 'ERROR: Magento download failed'
        exit 1
      fi

      if ! unzip -q /tmp/magento.zip -d /tmp/magento
      then
        >&2 echo 'ERROR: Magento installation failed'
        exit 1
      fi

      rm -f /tmp/magento.zip

      if ! composer install -d /tmp/magento
      then
        >&2 echo 'ERROR: Magento setup failed'
        exit 1
      fi

      mkdir -p /tmp/magento/app/code/NS8

      if ! ln -s `pwd` /tmp/magento/app/code/NS8/Protect
      then
        >&2 echo 'ERROR: Module installation failed'
        exit 1
      fi

      cd /tmp/magento
      chmod 755 vendor/phpunit/phpunit/phpunit

      if ! vendor/phpunit/phpunit/phpunit -c dev/tests/unit/phpunit.xml.dist app/code/NS8/Protect/Test
      then
        >&2 echo 'ERROR: Module tests failed'
        exit 1
      fi
