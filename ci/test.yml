---
platform: linux

image_resource:
  type: registry-image
  source: { repository: php, tag: cli }

inputs:
  - name: ns8-magento-platform

run:
  path: /bin/sh
  args:
    - -c
    - |
      apt-get update
      apt-get install -y git unzip wget yarnpkg
      echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN}' > ~/.npmrc

      ## TODO: Uncomment when we have tests!
      #pecl install xdebug
      #docker-php-ext-enable xdebug

      EXPECTED_SIGNATURE="$(wget -q -O - https://composer.github.io/installer.sig)"
      php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
      ACTUAL_SIGNATURE="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

      if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
        >&2 echo 'ERROR: Invalid installer signature'
        rm -f composer-setup.php
        exit 1
      fi

      php composer-setup.php --filename=composer --install-dir=/usr/local/bin --quiet

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Composer setup failed'
        exit 1
      fi

      cd ns8-magento-platform
      yarnpkg

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Yarn install failed'
        exit 1
      fi

      yarnpkg build:dev

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Switches build failed'
        exit 1
      fi

      yarnpkg lint

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Yarn lint failed'
        exit 1
      fi

      cd module
      composer install --no-autoloader --no-progress -q

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Composer install failed'
        exit 1
      fi

      ./vendor/bin/phpcs --config-set installed_paths vendor/magento/magento-coding-standard/Magento2/

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: PHP_CodeSniffer setup failed'
        exit 1
      fi

      composer lint

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: PHP lint check failed'
        exit 1
      fi
